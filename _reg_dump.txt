import 'package:flutter/material.dart';
import '../../theme/app_colors.dart';
import '../../widgets/animated_wave.dart';
import 'login_screen.dart';
import '../../api/api_client.dart';
import '../../api/auth_api.dart';
import '../../api/token_storage.dart';

class RegisterScreen extends StatefulWidget {
  const RegisterScreen({super.key});

  @override
  State<RegisterScreen> createState() => _RegisterScreenState();
}

class _RegisterScreenState extends State<RegisterScreen>
    with SingleTickerProviderStateMixin {
  final _firstNameController = TextEditingController();
  final _lastNameController = TextEditingController();
  final _emailController = TextEditingController();
  final _passwordController = TextEditingController();
  final _confirmController = TextEditingController();

  bool _visible = false;
  bool _loading = false;
  String? _error;

  late AnimationController _anim;
  late Animation<double> _fade;

  @override
  void initState() {
    super.initState();
    _anim = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 900),
    );
    _fade = CurvedAnimation(parent: _anim, curve: Curves.easeInOut);
    _anim.forward();
  }

  @override
  void dispose() {
    _anim.dispose();
    _firstNameController.dispose();
    _lastNameController.dispose();
    _emailController.dispose();
    _passwordController.dispose();
    _confirmController.dispose();
    super.dispose();
  }

  Future<void> _register() async {
    if (_passwordController.text != _confirmController.text) {
      setState(() => _error = 'РџР°СЂРѕР»Рё РЅРµ СЃРѕРІРїР°РґР°СЋС‚!');
      return;
    }

    setState(() {
      _loading = true;
      _error = null;
    });

    try {
      final api = ApiClient();
      final auth = AuthApi(api, TokenStorage());
      await auth.register(
        firstName: _firstNameController.text.trim(),
        lastName: _lastNameController.text.trim(),
        email: _emailController.text.trim(),
        password: _passwordController.text,
      );
      if (!mounted) return;
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          backgroundColor: AppColors.primary,
          content: Text(
            'Р РµРіРёСЃС‚СЂР°С†РёСЏ СѓСЃРїРµС€РЅР°! РўРµРїРµСЂСЊ РІРѕР№РґРёС‚Рµ.',
            style: TextStyle(fontFamily: 'MinecraftRus'),
          ),
        ),
      );
      Navigator.pushReplacement(
        context,
        MaterialPageRoute(builder: (_) => const LoginScreen()),
      );
    } catch (e) {\n      final msg = e.toString();\n      final friendly = msg.contains('exists') || msg.contains('Already') || msg.contains('уже')\n          ? 'Этот email уже зарегистрирован'\n          : 'Ошибка регистрации: ' + msg;\n      setState(() => _error = friendly);\n    } finally {
      if (mounted) setState(() => _loading = false);
    }
  }

  InputDecoration _dec(String hint, {Widget? suffix}) => InputDecoration(
        hintText: hint,
        hintStyle: const TextStyle(fontFamily: 'MinecraftRus'),
        filled: true,
        fillColor: Colors.white,
        suffixIcon: suffix,
        border: OutlineInputBorder(
          borderRadius: BorderRadius.circular(14),
          borderSide: BorderSide.none,
        ),
      );

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: AppColors.background,
      body: Stack(
        children: [
          Align(
            alignment: Alignment.bottomCenter,
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: const [
                AnimatedWave(color: AppColors.accent, height: 90, offset: 0),
                AnimatedWave(color: AppColors.primary, height: 100, offset: 1),
              ],
            ),
          ),

          // Р¤РѕСЂРјР°
          FadeTransition(
            opacity: _fade,
            child: SingleChildScrollView(
              padding: const EdgeInsets.symmetric(horizontal: 28, vertical: 50),
              child: Column(
                children: [
                  Image.asset('assets/images/splash_logo.png', height: 90),
                  const SizedBox(height: 20),
                  const Text(
                    'Р РµРіРёСЃС‚СЂР°С†РёСЏ',
                    style: TextStyle(
                      fontFamily: 'MinecraftRus',
                      fontSize: 20,
                      fontWeight: FontWeight.bold,
                      color: AppColors.textDark,
                    ),
                  ),
                  const SizedBox(height: 24),

                  TextField(
                    controller: _firstNameController,
                    style: const TextStyle(fontFamily: 'MinecraftRus'),
                    decoration: _dec('РРјСЏ'),
                  ),
                  const SizedBox(height: 14),
                  TextField(
                    controller: _lastNameController,
                    style: const TextStyle(fontFamily: 'MinecraftRus'),
                    decoration: _dec('Р¤Р°РјРёР»РёСЏ'),
                  ),
                  const SizedBox(height: 14),
                  TextField(
                    controller: _emailController,
                    keyboardType: TextInputType.emailAddress,
                    style: const TextStyle(fontFamily: 'MinecraftRus'),
                    decoration: _dec('Email'),
                  ),
                  const SizedBox(height: 14),
                  TextField(
                    controller: _passwordController,
                    obscureText: !_visible,
                    style: const TextStyle(fontFamily: 'MinecraftRus'),
                    decoration: _dec(
                      'РџР°СЂРѕР»СЊ',
                      suffix: IconButton(
                        icon: Icon(
                          _visible ? Icons.visibility_off : Icons.visibility,
                          color: AppColors.textGray,
                        ),
                        onPressed: () => setState(() => _visible = !_visible),
                      ),
                    ),
                  ),
                  const SizedBox(height: 14),
                  TextField(
                    controller: _confirmController,
                    obscureText: true,
                    style: const TextStyle(fontFamily: 'MinecraftRus'),
                    decoration: _dec('РџРѕРІС‚РѕСЂРёС‚Рµ РїР°СЂРѕР»СЊ'),
                  ),

                  const SizedBox(height: 20),
                  if (_error != null)
                    Text(
                      _error!,
                      style: const TextStyle(
                        fontFamily: 'MinecraftRus',
                        color: Colors.red,
                        fontSize: 13,
                      ),
                    ),

                  const SizedBox(height: 20),

                  SizedBox(
                    width: double.infinity,
                    child: ElevatedButton(
                      onPressed: _loading ? null : _register,
                      style: ElevatedButton.styleFrom(
                        backgroundColor: AppColors.primary,
                        padding: const EdgeInsets.symmetric(vertical: 14),
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(12),
                        ),
                        elevation: 5,
                      ),
                      child: _loading
                          ? const SizedBox(
                              width: 24,
                              height: 24,
                              child: CircularProgressIndicator(
                                color: Colors.white,
                                strokeWidth: 2.5,
                              ),
                            )
                          : const Text(
                              'Р—Р°СЂРµРіРёСЃС‚СЂРёСЂРѕРІР°С‚СЊСЃСЏ',
                              style: TextStyle(
                                fontFamily: 'MinecraftRus',
                                color: Colors.white,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                    ),
                  ),

                  const SizedBox(height: 16),
                  GestureDetector(
                    onTap: () {
                      Navigator.pushReplacement(
                        context,
                        MaterialPageRoute(
                            builder: (_) => const LoginScreen()),
                      );
                    },
                    child: const Text(
                      'РЈР¶Рµ РµСЃС‚СЊ Р°РєРєР°СѓРЅС‚? Р’РѕР№С‚Рё',
                      style: TextStyle(
                        fontFamily: 'MinecraftRus',
                        color: AppColors.primary,
                      ),
                    ),
                  ),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }
}



